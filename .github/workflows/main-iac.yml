name: IaC Full Stack

on:
  push:
    branches:
    - develop
    paths:
    - '.iac/**'

env: 
  stackVersion: 'v3'
  stackLocation: 'eastus'
  stackLocationCode: 'us1'
  AppName: 'resume'
  AppBackendName: 'resumecounter'
  tagCostCenter: 'xyz789'

jobs:

  deployDevelopment:
    # needs: build
    name: Deploy IaC to development
    environment:
      name: development
    env:
      stackEnvironment: 'dev'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@main
    - name: Azure Login
      uses: Azure/login@v1.1
      with:
        creds: ${{ secrets.RESUME_GITHUB_V3_SP }}   
    
    - name: Get and Set Subscription Variable
      id: subs
      run: |
        SUBID=$(az account show --query id --output tsv)
        echo "::set-output name=SUBID::${SUBID}"
    - name: Echo SubscriptionId
      run: echo "${{ steps.subs.outputs.subid }}"      
    
    - name: Echo Github.run_id
      id: runId
      run: |
        echo "${{ github.run_id }}"

    - name: Echo Github.run_number
      id: runNumber
      run: |
        echo "${{ github.run_number }}"

    - name: Echo Github.run_attempt
      id: runAttempt
      run: |
        echo "${{ github.run_Attempt }}"
    
    - name: Echo and Set Github Run Link
      id: IACACTIONSLINK
      run: |
        echo "${{ github.server_url }}/${{ github.repository }}/actions/workflows/main-iac.yml"
        IACACTIONSLINK=${{ github.server_url }}/${{ github.repository }}/actions/workflows/main-iac.yml
        echo "::set-output name=IACACTIONSLINK::${IACACTIONSLINK}"
 
    - name: Deploy Azure Resource Manager (ARM) Template
      uses: Azure/arm-deploy@v1
      with:
        scope: subscription
        subscriptionId: ${{ steps.subs.outputs.subid }}
        region: eastus
        template: ./.iac/main-dev.bicep
        parameters: 
                  tagGitActionIacRunId=${{ github.run_id }}
                  tagGitActionIacRunNumber=${{ github.run_number }}
                  tagGitActionIacRunAttempt=${{ github.run_attempt }}
                  tagGitActionIacActionsLink=${{ steps.iacactionslink.outputs.iacactionslink}}
                  resourceGroupLocation=${{env.stackLocation}}
                  tagEnvironmentNameTier=${{env.stackEnvironment}}
                  tagCostCenter=${{env.tagCostCenter}}
                  rgBackendName=${{env.stackLocationCode}}-${{env.AppName}}-be-${{env.stackEnvironment}}-${{env.stackVersion}}-rg
                  rgFrontendName=${{env.stackLocationCode}}-${{env.AppName}}-fe-${{env.stackEnvironment}}-${{env.stackVersion}}-rg
                  vnetName=${{env.stackLocationCode}}-${{env.AppName}}-${{env.stackEnvironment}}-${{env.stackVersion}}-vnet
                  vnetAddressPrefix=12.0.0.0/16
                  subnetName1=${{env.stackLocationCode}}-${{env.AppName}}-${{env.stackEnvironment}}-${{env.stackVersion}}-vnet-sn-1
                  subnetPrefix1=12.0.1.0/24
  # DeployProduction:
  #   needs: deployDevelopment
  #   name: Deploy to production
  #   environment:
  #     name: production
  #   runs-on: ubuntu-latest
  #   steps:
  #   - name: Download artifacts
  #     uses: actions/download-artifact@v2
  #     with:
  #       name: main-prod
  #   - name: Azure Login
  #     uses: Azure/login@v1.1
  #     with:
  #       creds: ${{ secrets.AZURE_CREDENTIALS }}
  #   - name: get subs
  #     id: subs
  #     run: |
  #       SUBID=$(az account show --query id --output tsv)
  #       echo "::set-output name=SUBID::${SUBID}"
  #   - name: Test
  #     run: echo "${{ steps.subs.outputs.subid }}"
  #   - name: Deploy Azure Resource Manager (ARM) Template
  #     uses: Azure/arm-deploy@v1
  #     with:
  #       scope: subscription
  #       subscriptionId: ${{ steps.subs.outputs.subid }}
  #       region: westeurope
  #       template: main-prod.json
